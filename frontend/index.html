<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sharp Movement App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        inter: ['Inter', 'sans-serif'],
                    },
                },
            },
        };
    </script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>

    <style>
        html, body, #react-root {
            height: 100%;
            margin: 0;
            background-color: #f9fafb;
        }
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.75); display: flex; justify-content: center; align-items: center; z-index: 10000; }
        .modal-content { background: white; padding: 24px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); max-width: 90%; width: 500px; }
    </style>
</head>
<body>
    <div id="react-root"></div>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo } = React;
        
        const textColor = 'text-gray-800';
        const rounded = 'rounded-lg';
        const dangerColor = 'bg-red-600';
        const dangerHoverColor = 'hover:bg-red-700';
        const buttonTextColor = 'text-white';
        const shadow = 'shadow-md';
        const cardBgColor = 'bg-white';
        const bgColorClass = 'bg-gray-50';

        const ConfirmModal = ({ show, title, message, onConfirm, onCancel }) => {
            if (!show) return null;
            return (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <h3 className={`text-xl font-bold mb-4 ${textColor}`}>{title}</h3>
                        <p className={`mb-6 ${textColor}`}>{message}</p>
                        <div className="flex justify-end gap-3">
                            <button onClick={onCancel} className={`py-2 px-4 ${rounded} bg-gray-200 ${textColor} font-semibold hover:bg-gray-300`}>Cancel</button>
                            <button onClick={onConfirm} className={`py-2 px-4 ${rounded} ${dangerColor} ${buttonTextColor} font-semibold ${dangerHoverColor}`}>Confirm</button>
                        </div>
                    </div>
                </div>
            );
        };
        
        const Pagination = ({ currentPage, totalPages, onPageChange }) => {
            const getPageNumbers = () => {
                const pages = [];
                if (totalPages <= 5) { for (let i = 1; i <= totalPages; i++) pages.push(i); }
                else {
                    pages.push(1);
                    if (currentPage > 3) pages.push('...');
                    const startPage = Math.max(2, currentPage - 1);
                    const endPage = Math.min(totalPages - 1, currentPage + 1);
                    for (let i = startPage; i <= endPage; i++) pages.push(i);
                    if (currentPage < totalPages - 2) pages.push('...');
                    pages.push(totalPages);
                }
                return pages;
            };

            return (
                <div className="flex items-center justify-center gap-2 mt-4">
                    <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">Previous</button>
                    {getPageNumbers().map((page, index) =>
                        typeof page === 'number' ? (
                            <button key={index} onClick={() => onPageChange(page)} className={`px-3 py-1 text-sm border rounded-md ${currentPage === page ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}`}>{page}</button>
                        ) : ( <span key={index} className="px-3 py-1 text-sm text-gray-500">{page}</span> )
                    )}
                    <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="px-3 py-1 text-sm bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50">Next</button>
                </div>
            );
        };

        function App() {
            const [stableAppId] = useState(() => typeof __app_id !== 'undefined' ? __app_id : 'default-canvas-app-id');
            const [db, setDb] = useState(null);
            const [allOddsData, setAllOddsData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState('');
            const [displayedOddsData, setDisplayedOddsData] = useState([]);
            const [availableSports, setAvailableSports] = useState([]);
            const [selectedSportFilter, setSelectedSportFilter] = useState('All');
            const [sortColumn, setSortColumn] = useState('Timestamp');
            const [sortDirection, setSortDirection] = useState('desc');
            const [currentPage, setCurrentPage] = useState(1);
            const [itemsPerPage, setItemsPerPage] = useState(10);
            const [showConfirmModal, setShowConfirmModal] = useState(false);
            const [recommendedBets, setRecommendedBets] = useState([]);

            const tableColumns = useMemo(() => [
                { key: 'Timestamp', label: 'Fetched Time', sortable: true },
                { key: 'CommenceTime', label: 'Game Time', sortable: true },
                { key: 'Sport', label: 'Sport', sortable: true },
                { key: 'Event', label: 'Event', sortable: true },
                { key: 'Confidence', label: 'Confidence', sortable: true },
                { key: 'AIOutcome', label: 'AI Outcome', sortable: false },
            ], []);
            
            useEffect(() => {
                try {
                    const parsedFirebaseConfig = JSON.parse(__firebase_config || '{}');
                    const app = firebase.initializeApp(parsedFirebaseConfig);
                    const firestoreDb = firebase.firestore(app);
                    const firebaseAuth = firebase.auth(app);
                    setDb(firestoreDb);

                    const unsubscribeAuth = firebaseAuth.onAuthStateChanged(async user => {
                        if (!user) {
                             await firebaseAuth.signInAnonymously();
                        } else {
                            const oddsRef = firestoreDb.collection(`artifacts/${stableAppId}/public/data/sports_odds`);
                            const unsubscribeSnapshot = oddsRef.onSnapshot(snapshot => {
                                const odds = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                                setAllOddsData(odds);
                                const uniqueSports = [...new Set(odds.map(o => o.Sport).filter(Boolean))];
                                setAvailableSports(['All', ...uniqueSports.sort()]);
                                setLoading(false);
                            }, err => { setError(`Failed to load odds: ${err.message}`); setLoading(false); });
                            return () => unsubscribeSnapshot();
                        }
                    });
                    return () => unsubscribeAuth();
                } catch(e) { setError(e.message); setLoading(false); }
            }, [stableAppId]);

            useEffect(() => {
                const recommendations = allOddsData
                    .filter(bet => bet.AIOutcome)
                    .sort((a, b) => b.Confidence - a.Confidence);
                setRecommendedBets(recommendations);
            }, [allOddsData]);

            const filteredData = useMemo(() => {
                let data = allOddsData.filter(odd => selectedSportFilter === 'All' || odd.Sport === selectedSportFilter);
                return data.sort((a, b) => {
                    const order = sortDirection === 'asc' ? 1 : -1;
                    let valA = a[sortColumn]; let valB = b[sortColumn];
                    if (valA == null) return 1; if (valB == null) return -1;
                    if (['Timestamp', 'CommenceTime'].includes(sortColumn)) { valA = new Date(valA).getTime(); valB = new Date(valB).getTime(); }
                    if (valA < valB) return -1 * order; if (valA > valB) return 1 * order;
                    return 0;
                });
            }, [allOddsData, selectedSportFilter, sortColumn, sortDirection]);

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);

            useEffect(() => {
                const newPage = Math.max(1, Math.min(currentPage, totalPages || 1));
                const startIndex = (newPage - 1) * itemsPerPage;
                setDisplayedOddsData(filteredData.slice(startIndex, startIndex + itemsPerPage));
                if(currentPage !== newPage) setCurrentPage(newPage);
            }, [currentPage, totalPages, filteredData, itemsPerPage]);

            const handleSortClick = useCallback(columnKey => {
                setSortDirection(prev => sortColumn === columnKey && prev === 'asc' ? 'desc' : 'asc');
                setSortColumn(columnKey);
                setCurrentPage(1);
            }, [sortColumn]);

            const confirmClearData = async () => {
                if (!db) return;
                const oddsCollection = db.collection(`artifacts/${stableAppId}/public/data/sports_odds`);
                const snapshot = await oddsCollection.get();
                const batch = db.batch();
                snapshot.docs.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                setShowConfirmModal(false);
            };

            if (loading) return <div className="flex items-center justify-center h-screen"><div className="text-xl">Loading Data...</div></div>;
            if (error) return <div className="flex items-center justify-center h-screen"><div className="text-xl text-red-600 bg-red-100 p-4 rounded-lg">Error: {error}</div></div>;

            return (
                <div className={`p-4 sm:p-6 lg:p-8 min-h-screen ${bgColorClass} ${textColor}`}>
                    <ConfirmModal show={showConfirmModal} title="Confirm Clear Data" message="Are you sure you want to delete all odds data?" onConfirm={confirmClearData} onCancel={() => setShowConfirmModal(false)} />
                    <div className="max-w-7xl mx-auto">
                        <h1 className="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-teal-500 pb-2">Sharp Movement Monitor</h1>
                        <p className="text-gray-600 mb-6">Displaying Pre-Analyzed Data from Backend</p>
                        
                        <div className={`p-4 mb-6 ${cardBgColor} ${rounded} ${shadow}`}>
                            <h2 className="text-xl font-bold text-indigo-700 mb-4 flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" /></svg>
                                AI Recommended Bets
                            </h2>
                            {recommendedBets.length > 0 ? (
                                <div className="space-y-3 max-h-60 overflow-y-auto pr-2">
                                    {recommendedBets.map(bet => {
                                        const confidenceColor = bet.Confidence >= 80 ? 'border-green-500' : bet.Confidence >= 65 ? 'border-yellow-500' : 'border-gray-200';
                                        return ( <div key={bet.id} className={`p-3 bg-gray-50 rounded-md border-l-4 ${confidenceColor}`}> <div className="flex items-center justify-between"> <div> <p className="font-semibold text-gray-800">{bet.Event}</p> <p className="text-xs text-gray-500">{bet.Sport}</p> </div> <span className={`font-bold text-lg ${bet.Confidence >= 80 ? 'text-green-600' : 'text-indigo-600'}`}>{bet.Confidence}%</span> </div> <p className="text-indigo-600 font-medium mt-1">{bet.AIOutcome}</p> </div> );
                                    })}
                                </div>
                            ) : ( <p className="text-gray-500">No recommendations available. Data is populated by the backend script.</p> )}
                        </div>

                        <div className={`p-4 mb-6 ${cardBgColor} ${rounded} ${shadow}`}>
                            <div className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                                <div>
                                    <label htmlFor="sport-filter" className="block text-sm font-medium text-gray-700">Filter by Sport</label>
                                    <select id="sport-filter" value={selectedSportFilter} onChange={e => setSelectedSportFilter(e.target.value)} className={`mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm ${rounded}`}>
                                        {availableSports.map(sport => <option key={sport} value={sport}>{sport}</option>)}
                                    </select>
                                </div>
                                <button onClick={() => setShowConfirmModal(true)} className={`w-full py-2 px-4 ${rounded} ${buttonTextColor} font-semibold transition-colors flex items-center justify-center gap-2 ${dangerColor} ${dangerHoverColor}`}>
                                    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clipRule="evenodd" /></svg>
                                    Clear All Data
                                </button>
                           </div>
                        </div>

                        <div className={`overflow-x-auto ${cardBgColor} ${rounded} ${shadow}`}>
                             <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        {tableColumns.map(col => (
                                             <th key={col.key} scope="col" className="px-6 py-3 text-left text-xs font-bold text-gray-600 uppercase tracking-wider cursor-pointer" onClick={() => col.sortable && handleSortClick(col.key)}>
                                                {col.label}
                                                {sortColumn === col.key && (<span>{sortDirection === 'asc' ? ' ▲' : ' ▼'}</span>)}
                                            </th>
                                        ))}
                                    </tr>
                                </thead>
                                <tbody>
                                    {displayedOddsData.map((row, index) => (
                                        <tr key={row.id} className={`${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-indigo-50`}>
                                            {tableColumns.map(col => (
                                                <td key={`${row.id}-${col.key}`} className={`px-6 py-4 whitespace-nowrap text-sm ${col.key === 'Confidence' ? 'font-bold text-indigo-700' : 'text-gray-700'}`}>
                                                    {['Timestamp', 'CommenceTime'].includes(col.key) && row[col.key] ? new Date(row[col.key]).toLocaleString() : (row[col.key] ?? '')}
                                                </td>
                                            ))}
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                            <Pagination currentPage={currentPage} totalPages={totalPages} onPageChange={setCurrentPage} />
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('react-root')).render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>
